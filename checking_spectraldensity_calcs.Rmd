---
title: "Checking Spectral Density Calculations"
author: "Kassel Hingee"
date: "5 January 2016"
output: html_document
---

Following some tests performed in Böhm (2002), namely the Boolean model of discs with radius 10.
```{r}
library(stationaryracsinference)
discr <- 10
lambda <- 2.2064E-3
grainlib <- solist(disc(radius=discr))
bufferdist <- 12 #chosen to be larger than the largest radius in library
w <- owin(xrange=c(0,500),yrange=c(0,500)) #large numbers of points makes attaching grains take forever!?
pp <- rpoispp(lambda=lambda,win=dilation(w,bufferdist),nsim=1,drop=TRUE)#lambda from B\"{o}m (2002) - chosen to make coverage probability very close to 0.5
xibuffer <- placegrainsfromlib(pp,grainlib)
xi <- intersect.owin(xibuffer,w)
plot(xi)
```

`bufferdist <- 12` chosen to be larger than the radius so that points outside the buffer will not intersect in the region of interest (`w`).

`lambda=2.2064E-3` was chosen following Böhm et al. They chose this intensity to make the coverage fraction very close to 0.5.

# Theoretical Covariance and Spectral Density
The theoretical covariance $C(v) := P(\{o,v\} \in \Xi$ is given in both Böhm (2002) and eqn. 3.18 Chiu (2014). It uses the set covariance of a deterministic disc (called `setcovdisc` here), and the Poisson property of the germs.

```{r}
setcovdisc <- function(r,discr){
  if (r>=2*discr){setcovariance <- 0}
  else {
    setcovariance <- 2*discr^2*acos(r/(2*discr)) - (r/2)*sqrt(4*discr^2-r^2)
  }
  return(setcovariance)
}
```

Compared this function to the empirically calculated set covariance to check it and the functions match very closely :).

```{r}
areaintersecteddiscs <- function(displacement,discr){
  intersecteddiscs <- intersect.owin(disc(radius=10,centre=c(0,0)),disc(radius=10,centre=c(displacement,0)))
  return(area(intersecteddiscs))
}
plot(1:100/5,lapply(1:100/5,areaintersecteddiscs,discr=discr))
lines(1:150/5,lapply(1:150/5,setcovdisc,discr=discr))
```

Combined with the Poisson property of the germs we get $C(v)$

```{r}
thcovDeterministicDiscs <- function(r,lambda,discr){
  expectedsetcovariance <- setcovdisc(r,discr)
  p <- 1-exp(-pi*discr^2*lambda)
  covariance <- 2*p-1+(1-p)^2*exp(lambda*expectedsetcovariance)
  return(covariance)
}
plot(1:110/5,lapply(1:110/5,thcovDeterministicDiscs,lambda = lambda, discr=discr))
```

 This seems to match some of my expectations: it finishes at $0.25 \approx p^2$, before $20$ it is the same shape as the set covariance, and at $0$ it is $\approx 0.5 \approx p$.

This needed to be converted into a function of 2D vectors.
```{r}
thcovDeterministicDiscs_vec <- function(X,Y,lambda,discr){
  rlist <- sqrt(X^2+Y^2)
  covar <- vector(length(rlist),mode="numeric")
  for (i in 1:length(rlist)){
    covar[i] <- thcovDeterministicDiscs(rlist[i],lambda=lambda,discr=discr)
  }
  return(covar)
}
```

Next created a matrix map of covariance. Here is my initial high resolution version (a low resolution version was needed for later as you will see).

```{r}
xpts <- 0:250/10
ypts <- 0:250/10
mat <- outer(xpts,ypts,FUN="thcovDeterministicDiscs_vec",lambda=lambda,discr=discr) #rows correspond to xstep - just a quirk of outer!
image(mat) #rows in mat correspond to X, columns correspond to Y, but image() plots things s.t. rows increment along the X axis
#reflect out to all corners
mat <- mat[,c((ncol(mat)):2,1:ncol(mat))]
mat <- mat[c((nrow(mat)):2,1:nrow(mat)),]
image(mat)
```

Checked that maximum was in the centre and that it is 0.5000069

```{r}
max(mat)
arrayInd(which.max(mat),dim(mat))
```

Yes it was! :)

Next compared to empirically generated covariance using the `covarianceRACS` function.

```{r}
thcov <- im(t(mat),xcol = c(-xpts[length(xpts):2],xpts),yrow=c(-ypts[length(ypts):2],ypts))
covar <- covarianceRACS(xi,w=Frame(xi))
plot(covar$covariance)
par(mfrow=c(1,2))
plot(covar$covariance,clipwin=Frame(thcov))
plot(thcov)
```

The empirical covariance estimate looks plausibly similar, but at a very low resolution. Forced a high resolution with the following (and it looked a lot nicer)

```{r}
covar <- covarianceRACS(as.mask(xi,dimyx=c(1000,1000)),w=Frame(xi))
plot(covar$covariance,clipwin=Frame(thcov))
plot(thcov)
```

However a plot of the full map shows the same speckledy stuff at about 0.3 in this higher resolution map. What is it??

```{r}
plot(covar$covariance)
```

I was happy that the theoretical covariance is correct. So next I converted it to spectral density using eqn 2.4 of Böhm (2002). Note that there is a slight subtlety in the notation in thata: $C(v)$ is defined as a above - the two point probability. But $Cov(v) := C(v) - p^2$. 

According to eqn 2.4 the spectral density is the Fourier transform of $Cov(v)$.

```{r}
p <- 1-exp(-pi*discr^2*lambda)
thspecdens <- fft(as.matrix(thcov)- p^2)
image(Re(thspecdens))
image(Im(thspecdens))
image(abs(thspecdens)[1:15,1:15])
```

Note that Real part and Imaginary parts are significant due to phase of thcov (ie. that the peak is in the centre of the image, not the corners). However the absolute value looks ok. Just a very low resolution. Increasing the spectral resolution is about increasing the length of the sample (its currently $0 -- 25$) because the spectral resolution is the reciprocal of this length (ie. spectral spacing currently $\frac{1}{25}$). 

But naively 8* the size of the matrix slowed/crashed my computer (and I don't think it gave enough resolution even then).
 Solution was to make a low res version of the theoretical covariance.

```{r}
xptsLR <- 0:120/4
yptsLR <- 0:120/4
mat <- outer(xptsLR,yptsLR,FUN="thcovDeterministicDiscs_vec",lambda=lambda,discr=discr) #rows correspond to xstep - just a quirk of outer!
image(mat) #rows in mat correspond to X, columns correspond to Y, but image() plots things s.t. rows increment along the X axis
#reflect out to all corners
mat <- mat[,c((ncol(mat)):2,1:ncol(mat))]
mat <- mat[c((nrow(mat)):2,1:nrow(mat)),]
image(mat)
M <- mat-p^2
nr <- nrow(M)
nc <- ncol(M)
#pad with lots of 0!
thcovpad <- matrix(0, ncol=8*nc, nrow=8*nr)
thcovpad[1:nr, 1:nc] <- M
thspecdensPadLR <- fft(thcovpad)/(nr*8*nc*8)
``` 

The absolution value of this is looking much nicer

```{r}
image(abs(thspecdensPadLR)[1:30,1:30])
```

Finally got something that should be quite similar to Bohm's 2002 diagram.

```{r}
smoothedspecdens6 <-spectraldensity(xi,Frame(xi),6,dimyx=c(512,512))
smoothedspecdens8 <- spectraldensity(xi,Frame(xi),8,dimyx=c(512,512))
smoothedspecdens10 <- spectraldensity(xi,Frame(xi),10,dimyx=c(512,512))
plot(0:(300-257),smoothedspecdens10[258,257:300]/(10^2),type="l") #**note the scaling error in smoothed spectral density
lines(0:(300-257),smoothedspecdens6[258,257:300]/(6^2),col="red")
lines(0:(300-257),smoothedspecdens8[258,257:300]/(8^2),col="green")
lines(1:30,abs(thspecdensPadLR)[1,1:30]*max(smoothedspecdens10/(10^2))/max(abs(thspecdensPadLR)),col="blue")
```

The red line (smoothed with bandwidth 6) has done something weird! In my first take it didn't do that.

Note the scaling issues in the smoothed versions - these need to be fixed - they should all be on the same scale. Also scaling between theoretical line and empirical lines shouldn't be needed BUT at least they were the same shape.

# REFERENCES
Böhm, S., Heinrich, L. and Schmidt, V. (2002) Kernel Estimation of the Spectral Density of Stationary Random Closed Sets. Germany.

Chiu, S.N., Stoyan, D., Kendall, W.S. and Mecke, J. (2013) Stochastic Geometry and Its Applications, 3rd ed. John Wiley & Sons.


