---
title: Applying coverage probability, covariance and contagion estimators to some
  UM tree data
author: "Kassel Hingee"
date: "12 January 2016"
output: html_document
bibliography: zotero.bib
---

**Aim:** Estimate coverage probability, covariance, Hest and contagion of trees, and tree change in a variety of regions. To test if the processing stream works and get an idea about the sort of experimental design choices I'll have to make.

**Background:** This is a preliminary experiment. In the future confidence intervals will be needed along with stationarity, large enough windows (and the extra assumptions for normality) should be tested. Also needed will be things for the estimators to predict. 


**Data:** I have extracted a few nearby subsets of tree height maps within two different vegetation complexes given by CBC_Feed_areas_requiring_investigation_SCP_IBRA_2007_clipped_SA_2014" shape files (provided by Ricky).
 This data set is based on the Draft Pre-European Swan Coastal Plain vegetation maps, and I beleive very little has changed (it was the most useful in the extents of the UM photography [Fig.~1 @glossop2011me]).
 For Carnaby Cockatoo habitat the vegetation description field was searched [@Glossop2011me] so the same field will be used for this experiment.
  Note that other fields could be more appropriate in the future (vegname, structure or category) but I don't know if there is a 1-1 relationship between veg name and veg description.

Maps of vegetation heights were from the Urban Monitor 2007, 2009 and 2014 data.

The different subsets were drawn by hand using QGIS of the moorSE tile in the Gnangara mound region.
This region was chosen because Ricky commented (70\% confident of my memory) that it is is particularly homogeneous for the UM region. 
 The moorSE tile was used because it contained a small region of one vegetation mosaic (Woodland of Banksia spp) near (actually was within) a different vegetation mosaic (Woodland of Banksia spp., Melaleuca spp. & Eucalyptus rudis over sedges). 
 From the DOM the vegetation looked fairly uniform (stationary) to the eye.

There were 7 polygons in total, and they were saved in /home/tearcor/PhDLargeDataFies/ExtractingSamplesUM_forPreEuroVegComparison .

Their locations are shown below as solid green squares.
Note that the black lines mark the boundaries between vegetation types.
![Locations of Vegetation Height Extracts](/home/tearcor/PhDLargeDataFies/ExtractingSamplesUM_forPreEuroVegComparison/polygonLocations.png)

# Processing

## Reading into R and processing to get a RACS
```{r}
library(raster)
library(rgdal)
library(spatstat)

#load raster data
ersfilename <- "/home/tearcor/PhDLargeDataFies/ExtractingSamplesUM_forPreEuroVegComparison/2007/polygon01_vht_2007.ers"
vhtraster <- raster(ersfilename)
tree2mmap <- vhtraster >= 2000 

#get change maps
ersfilenameA <- "/home/tearcor/PhDLargeDataFies/ExtractingSamplesUM_forPreEuroVegComparison/2007/polygon01_vht_2007.ers"
ersfilenameB <- "/home/tearcor/PhDLargeDataFies/ExtractingSamplesUM_forPreEuroVegComparison/2009/polygon01_vht_2009.ers"
tree2mchange  <- function (ersfilenameA,ersfilenameB){
  vhtrasterA <- raster(ersfilenameA)
  vhtrasterB <- raster(ersfilenameB)
  tree2mA <- (vhtrasterA >= 2000 & !is.na(vhtrasterA)) #assume all NA values are  observed non-veg
  tree2mB <- (vhtrasterB >= 2000 & !is.na(vhtrasterB))
  plot(tree2mB & (!tree2mA),main = "growth")
  growthmap <- tree2mB & (!tree2mA)
  lossmap <- tree2mA & (!tree2mB)
  
  #put NAs back in for converting owin object
  growthmap[growthmap < 0.5] <- NA
  lossmap[lossmap < 0.5] <- NA 
  change = list(growth = growthmap, loss = lossmap)
  return(change)
}
```

## Estimating parameters on Change Maps

### Polygon01
Load raster convert to change maps
```{r}
par(mfrow=c(1,3))
vhtraster07 <- raster("/home/tearcor/PhDLargeDataFies/ExtractingSamplesUM_forPreEuroVegComparison/2007/polygon01_vht_2007.ers")
vhtraster09 <- raster("/home/tearcor/PhDLargeDataFies/ExtractingSamplesUM_forPreEuroVegComparison/2009/polygon01_vht_2009.ers")
vhtraster14 <- raster("/home/tearcor/PhDLargeDataFies/ExtractingSamplesUM_forPreEuroVegComparison/2014/polygon01_vht_2014.ers")
plot(vhtraster07,main="polygon01: 2007")
plot(vhtraster09,main="polygon01: 2009")
plot(vhtraster14,main="polygon01: 2014")

change01_0709 <- tree2mchange("/home/tearcor/PhDLargeDataFies/ExtractingSamplesUM_forPreEuroVegComparison/2007/polygon01_vht_2007.ers","/home/tearcor/PhDLargeDataFies/ExtractingSamplesUM_forPreEuroVegComparison/2009/polygon01_vht_2009.ers")


plot.new()
par(mfrow=c(2,2))
plot(change01_0709$growth,main="Polygon01: 07-09 growth")  
plot(change01_0709$loss, main="Polygon01: 07-09 loss")

change01_0914 <- tree2mchange("/home/tearcor/PhDLargeDataFies/ExtractingSamplesUM_forPreEuroVegComparison/2009/polygon01_vht_2009.ers","/home/tearcor/PhDLargeDataFies/ExtractingSamplesUM_forPreEuroVegComparison/2014/polygon01_vht_2014.ers")

plot(change01_0914$growth,main="Polygon01: 09-14 growth")  
plot(change01_0914$loss, main="Polygon01: 09-14 loss")

plot.new()

#convert maps to spatstat owin format
library(maptools) #needed for as.im for some reason
change01_0914growth <- as.owin(as.im(change01_0914$growth))

```


Estimate coverage fraction

```{r}
library(stationaryracsinference)
coveragefrac <- covpest(change01_0914growth,Frame(change01_0914growth))
coveragefrac
#check that is is correct
sum(as.matrix(change01_0914$growth),na.rm = TRUE)/ncell(change01_0914$growth)
```

Covariance Map 

```{r}
par(mfrow=c(1,1))
twoptprob <- covarianceRACS(change01_0914growth,Frame(change01_0914growth))
plot(twoptprob$covariance,main="Two-Point Probability Estimate",axes=TRUE,xlab="metres")
plot(twoptprob$covariance,main="Two-Point Probability Estimate Zoom",axes=TRUE,xlab="metres",clipwin=owin(xrange=c(-5,5),yrange=c(-5,5)),xaxp=c(-4,4,5))
#raster plots have nicer axes, but poorer colours.
plot(raster(twoptprob$covariance),col=heat.colors(255))
```

Sph Contact Functions. What about Hazard Rates Too?
```{r}
sphContact <- list(growth = Hest(change01_0914growth),notgrowth = Hest(complement.owin(change01_0914growth)))

plot.new()
par(mfrow=c(1,2))
plot(sphContact$growth,main="growth",xlab="m",ylab="Sph. Contact Dist. H(r)")
plot(sphContact$growth,type="n",xlab="m",main="not growth",ylab="Sph. Contact Dist. H(r)")
plot(sphContact$notgrowth,main="not growth",xlab="m",add=TRUE,legend=TRUE)


#hazard ratessphContact$growth$
plot(sphContact$growth$r,sphContact$growth$hazard,main="growth",xlab="m",ylab="Hazard Rate",type="l")
plot(sphContact$growth$r,sphContact$growth$hazard,main="growth",xlab="m",ylab="Hazard Rate",type="n")
lines(sphContact$notgrowth$r,sphContact$notgrowth$hazard,main="not growth",xlab="m",type="l")

par(mfrow=c(1,1))
plot(sphContact$notgrowth$r,sphContact$notgrowth$hazard,main="not growth",xlab="m",type="l",ylab="Sph. Cont. Hazard Rate")
```

### Contagion Estimates

Calculate Two Pt Contagion 
```{r}
twoptprobcontag <- contagTwoPtProb(twoptprob$covariance,p=coveragefrac)
plot(twoptprobcontag,axes=TRUE)
plot(twoptprobcontag,axes=TRUE,clipwin=owin(xrange=c(-5,5),yrange=c(-5,5)),xaxp=c(-4,4,5))
```

Calculated Spherical Contact Contagion - must first harmonise $r$ values of Sph. Cont. Distributions
```{r}
sphContactHarm = harmonise(growth = sphContact[[1]],notgrowth = sphContact[[2]])


```


