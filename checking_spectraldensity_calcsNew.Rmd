---
title: "Checking Spectral Density Calculations: Take 2"
author: "Kassel Hingee"
date: "7 January 2016"
output: html_document
---

Previous tests found issues with the scaling of spectral density function. This document repeats the tests, but for the new spectral density.

Following some tests performed in Böhm (2002), namely the Boolean model of discs with radius 10.
```{r}
library(stationaryracsinference)
discr <- 10
lambda <- 2.2064E-3
grainlib <- solist(disc(radius=discr))
bufferdist <- 12 #chosen to be larger than the largest radius in library
w <- owin(xrange=c(0,500),yrange=c(0,500)) #large numbers of points makes attaching grains take forever!?
pp <- rpoispp(lambda=lambda,win=dilation(w,bufferdist),nsim=1,drop=TRUE)#lambda from B\"{o}m (2002) - chosen to make coverage probability very close to 0.5
xibuffer <- placegrainsfromlib(pp,grainlib)
xi <- intersect.owin(xibuffer,w)
plot(xi)
```

`bufferdist <- 12` chosen to be larger than the radius so that points outside the buffer will not intersect in the region of interest (`w`).

`lambda=2.2064E-3` was chosen following Böhm et al. They chose this intensity to make the coverage fraction very close to 0.5.

# Theoretical Covariance and Spectral Density
The theoretical covariance $C(v) := P(\{o,v\} \in \Xi$ is given in both Böhm (2002) and eqn. 3.18 Chiu (2014). It uses the set covariance of a deterministic disc (called `setcovdisc` here), and the Poisson property of the germs.

```{r}
setcovdisc <- function(r,discr){
  if (r>=2*discr){setcovariance <- 0}
  else {
    setcovariance <- 2*discr^2*acos(r/(2*discr)) - (r/2)*sqrt(4*discr^2-r^2)
  }
  return(setcovariance)
}
```

Compared this function to the empirically calculated set covariance to check it and the functions match very closely :).

```{r}
areaintersecteddiscs <- function(displacement,discr){
  intersecteddiscs <- intersect.owin(disc(radius=10,centre=c(0,0)),disc(radius=10,centre=c(displacement,0)))
  return(area(intersecteddiscs))
}
plot(1:100/5,lapply(1:100/5,areaintersecteddiscs,discr=discr))
lines(1:150/5,lapply(1:150/5,setcovdisc,discr=discr))
```

Combined with the Poisson property of the germs we get $C(v)$

```{r}
thcovDeterministicDiscs <- function(r,lambda,discr){
  expectedsetcovariance <- setcovdisc(r,discr)
  p <- 1-exp(-pi*discr^2*lambda)
  covariance <- 2*p-1+(1-p)^2*exp(lambda*expectedsetcovariance)
  return(covariance)
}
plot(1:110/5,lapply(1:110/5,thcovDeterministicDiscs,lambda = lambda, discr=discr))
```

 This seems to match some of my expectations: it finishes at $0.25 \approx p^2$, before $20$ it is the same shape as the set covariance, and at $0$ it is $\approx 0.5 \approx p$.

This needed to be converted into a function of 2D vectors.
```{r}
thcovDeterministicDiscs_vec <- function(X,Y,lambda,discr){
  rlist <- sqrt(X^2+Y^2)
  covar <- vector(length(rlist),mode="numeric")
  for (i in 1:length(rlist)){
    covar[i] <- thcovDeterministicDiscs(rlist[i],lambda=lambda,discr=discr)
  }
  return(covar)
}
```

Next created a matrix map of covariance. Here is my initial high resolution version (a low resolution version was needed for later as you will see).

```{r}
xpts <- 0:250/10
ypts <- 0:250/10
mat <- outer(xpts,ypts,FUN="thcovDeterministicDiscs_vec",lambda=lambda,discr=discr) #rows correspond to xstep - just a quirk of outer!
#reflect out to all corners
mat <- mat[,c((ncol(mat)):2,1:ncol(mat))]
mat <- mat[c((nrow(mat)):2,1:nrow(mat)),]
image(mat)
```

Checked that maximum was in the centre and that it is 0.5000069

```{r}
max(mat)
arrayInd(which.max(mat),dim(mat))
```

Yes it was! :)

Next compared to empirically generated covariance using the `covarianceRACS` function.

```{r}
thcov <- im(t(mat),xcol = c(-xpts[length(xpts):2],xpts),yrow=c(-ypts[length(ypts):2],ypts))
covar <- covarianceRACS(xi,w=Frame(xi))
plot(covar$covariance)
par(mfrow=c(1,2))
plot(covar$covariance,clipwin=Frame(thcov))
plot(thcov)
```

The empirical covariance estimate looks plausibly similar, but at a very low resolution. Forced a high resolution with the following (and it looked a lot nicer)

```{r}
covarHD <- covarianceRACS(as.mask(xi,dimyx=c(1000,1000)),w=Frame(xi))
par(mfrow=c(1,2))
plot(covarHD$covariance,clipwin=Frame(thcov))
plot(thcov)
```

However a plot of the full map shows the same speckledy stuff at about 0.3 in this higher resolution map. What is it??

```{r}
plot(solist(LowRes=covar$covariance,HighRes = covarHD$covariance),main="Full Covariance Maps")
```

I was happy that the theoretical covariance is correct. So next I converted it to spectral density using eqn 2.4 of Böhm (2002). Note that there is a slight subtlety in the notation in thata: $C(v)$ is defined as a above - the two point probability. But $Cov(v) := C(v) - p^2$. 

According to eqn 2.4 the spectral density is the Fourier transform of $Cov(v)$.

```{r}
p <- 1-exp(-pi*discr^2*lambda)
thspecdens <- fft(as.matrix(thcov)- p^2)
image(Re(thspecdens))
image(Im(thspecdens))
image(abs(thspecdens)[1:15,1:15])
```

Note that Real part and Imaginary parts are significant due to phase of thcov (ie. that the peak is in the centre of the image, not the corners). However the absolute value looks ok. Just a very low resolution. Increasing the spectral resolution is about increasing the length of the sample (its currently $0 -- 25$) because the spectral resolution is the reciprocal of this length (ie. spectral spacing currently $\frac{1}{25}$). 

But naively 8* the size of the matrix slowed/crashed my computer (and I don't think it gave enough resolution even then).
 Solution was to make a low res version of the theoretical covariance.

```{r}
xptsLR <- 0:120/4
yptsLR <- 0:120/4
mat <- outer(xptsLR,yptsLR,FUN="thcovDeterministicDiscs_vec",lambda=lambda,discr=discr) #rows correspond to xstep - just a quirk of outer!
#reflect out to all corners
mat <- mat[,c((ncol(mat)):2,1:ncol(mat))]
mat <- mat[c((nrow(mat)):2,1:nrow(mat)),]
M <- mat-p^2
nr <- nrow(M)
nc <- ncol(M)
#pad with lots of 0!
thcovpad <- matrix(0, ncol=8*nc, nrow=8*nr)
thcovpad[1:nr, 1:nc] <- M
scalefactorX <- (xptsLR[2]-xptsLR[1])
scalefactorY <- (yptsLR[2]-yptsLR[1]) 
thspecdensPadLR <- scalefactorX*scalefactorY*fft(thcovpad)
``` 

The absolute value of this is looking much nicer, and the size is the same as in Bohm's 2002 figure.

```{r}
par(mfrow=c(1,2))
image(abs(thspecdensPadLR)[1:30,1:30])
plot(1:30,abs(thspecdensPadLR)[1,1:30]) 
```

However my calculations of phase shift seem to be wrong (or my implmentation below is wrong) because it doesn't covert the spectral density to purely real. Luckily this doesn't matter because absolute value does it perfectly and I'm confident it is only a phase shift.

```{r}
spectralpointsX <- (2*pi/(scalefactorX*nrow(thcovpad))) * (0:(nrow(thcovpad)-1))
spectralpointsY <- (2*pi/(scalefactorY*ncol(thcovpad))) * (0:(ncol(thcovpad)-1))
firstpointX <- -xptsLR[length(xptsLR)]
firstpointY <- -yptsLR[length(yptsLR)]

phaseshiftmatrix <- exp(1i*outer(spectralpointsX*firstpointX,spectralpointsY*firstpointY,FUN = "+"))

par(mfrow=c(1,2))
filled.contour(Re(thspecdensPadLR[1:30,1:30]*phaseshiftmatrix[1:30,1:30]),main="Real Part")
filled.contour(Im(thspecdensPadLR[1:30,1:30]*phaseshiftmatrix[1:30,1:30]),main="Imaginary Part")
```

# Comparing to Empirical Spectral Density

Checkout unsmoothed version first

```{r}
unsmsd <- unsmoothedspectraldensity(xi,Frame(xi),dimyx=c(512,512))
par(mfrow=c(1,2))
plot(unsmsd,main="Full")
plot(unsmsd,clipwin=owin(xrange = c(-0.075,0.075),yrange=c(-0.075,0.075)),main="Zoom")
dev.off()
plot(0:(300-257),unsmsd[258,257:300],main="Unsmoothed Spectral Density")
lines(0:59,abs(thspecdensPadLR)[1,1:60])
```

Finally got something that akin to Bohm's 2002 diagram. Except my spectral coordinates are at a different scale. The unsmoothed spectral density is enclosed within [-0.513, 0.513] x [-0.513, 0.513] (units = (spatial units)^-1) and the peak is enclosed within [-0.075, 0.075] x [-0.075, 0.075]. So bandwidth of 0.1 is too large.

```{r}
smoothedsd01 <-spectraldensity(xi,Frame(xi),0.01,dimyx=c(512,512))
smoothedsd012 <-spectraldensity(xi,Frame(xi),0.012,dimyx=c(512,512))
smoothedsd015 <-spectraldensity(xi,Frame(xi),0.015,dimyx=c(512,512))
smoothedsd02 <-spectraldensity(xi,Frame(xi),0.02,dimyx=c(512,512))
smoothedsd03 <-spectraldensity(xi,Frame(xi),0.03,dimyx=c(512,512))
smoothedsd05 <-spectraldensity(xi,Frame(xi),0.05,dimyx=c(512,512))
plot(0:(300-257),unsmsd[258,257:300],main="Spectral Density")
lines(0:59,abs(thspecdensPadLR)[1,1:60])
lines(0:(300-257),smoothedsd01[258,257:300],type="l",col="red") 
lines(0:(300-257),smoothedsd012[258,257:300],col="yellow")
lines(0:(300-257),smoothedsd015[258,257:300],type="l",col="blue") 
lines(0:(300-257),smoothedsd02[258,257:300],col="green") 
legend("topright",
       c("Unsmoothed","Theoretical","bw=0.01","bw=0.012","bw=0.015","bw=0.02"),
       col=c("black","black","red","yellow","green","green")
       ,lty=c(0,1,1,1,1,1),pch=c("o",".",".",".",".","."))
```

None of these match satisfactorily. What is happening? What if I use a higher resolution? Perhaps I'm not scaling the x-axis correctly!?

The separation between spectral values is $2\pi/\delta n = 2\pi/(total spatial width)$ where $\delta$ is the spatial separation, and $n$ is the number of (the equally spaced) sample points.

The low resolution theoretical covariance was estimated at 0...30 at 0.25 spacing which corresponds to a window of [-0.125,30.125], it was the reflected out to [-30.125,30.125] and padded by 8 times its size which would be a width of $\approx 482$.

```{r}
unsmsd <- unsmoothedspectraldensity(xi,Frame(xi),dimyx=c(1024,1024))
smoothedsd01 <-spectraldensity(xi,Frame(xi),0.01,dimyx=c(1024,1024))
smoothedsd012 <-spectraldensity(xi,Frame(xi),0.012,dimyx=c(1024,1024))
smoothedsd015 <-spectraldensity(xi,Frame(xi),0.015,dimyx=c(1024,1024))
plot((0:49)*unsmsd$xstep,unsmsd[513,513:562],main="Spectral Density - Higher Res Observation")
lines(0:59*(1/482),abs(thspecdensPadLR)[1,1:60])
```


# REFERENCES
Böhm, S., Heinrich, L. and Schmidt, V. (2002) Kernel Estimation of the Spectral Density of Stationary Random Closed Sets. Germany.

Chiu, S.N., Stoyan, D., Kendall, W.S. and Mecke, J. (2013) Stochastic Geometry and Its Applications, 3rd ed. John Wiley & Sons.


